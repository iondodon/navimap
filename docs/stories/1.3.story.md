# Story 1.3: User Location Detection and Display

## Status

Approved

## Story

**As a** user,
**I want** to see my current location on the map,
**so that** I can orient myself and understand where I am.

## Acceptance Criteria

1. Location permissions requested on first app launch with clear explanation (FR8)
2. User's GPS location detected and displayed as blue marker (FR2)
3. Map centers on user location when first detected
4. Location updates smoothly as user moves
5. Graceful handling of GPS signal loss with user feedback (FR9)
6. Handles location permissions denial appropriately
7. Works on both Android and iOS platforms (NFR4)

## Tasks / Subtasks

- [ ] Task 1: Create UserLocation Data Model (AC: 2)

  - [ ] Create lib/models/user_location.dart with required attributes
  - [ ] Add latitude, longitude, accuracy, and timestamp fields
  - [ ] Implement toLatLng() helper method for flutter_map integration
  - [ ] Add proper constructor with required/optional parameters
  - [ ] Include validation for coordinate ranges (-90 to 90 lat, -180 to 180 lng)

- [ ] Task 2: Implement LocationService Business Logic (AC: 1, 4, 5, 6, 7)

  - [ ] Create lib/services/location_service.dart class
  - [ ] Implement requestPermission() method with platform-specific handling
  - [ ] Create getLocationStream() for continuous location updates
  - [ ] Add getCurrentLocation() for one-time location fetch
  - [ ] Implement isLocationServiceEnabled() GPS status check
  - [ ] Add proper error handling for permissions denied and GPS disabled
  - [ ] Configure location settings: accuracy, update intervals, distance filters

- [ ] Task 3: Integrate LocationService with AppState (AC: 2, 3, 4)

  - [ ] Create lib/state/app_state.dart as ChangeNotifier
  - [ ] Add UserLocation? currentLocation field
  - [ ] Implement updateLocation(UserLocation) method with notifyListeners()
  - [ ] Add location stream subscription management
  - [ ] Include loading states and error states for location operations
  - [ ] Add proper disposal of location subscriptions

- [ ] Task 4: Update MapScreen for Location Display (AC: 2, 3)

  - [ ] Add Consumer<AppState> wrapper to MapScreen
  - [ ] Implement blue dot marker layer using MarkerLayer
  - [ ] Configure marker appearance: blue circle with accuracy ring
  - [ ] Add map auto-centering when location first detected
  - [ ] Ensure marker updates smoothly with location changes
  - [ ] Handle cases where location is null or unavailable

- [ ] Task 5: Location Permission Handling (AC: 1, 6)

  - [ ] Add permission explanation dialog with clear reasoning
  - [ ] Implement permission request flow on first app launch
  - [ ] Handle permission denied scenarios with graceful fallback
  - [ ] Add settings redirect for manually enabling permissions
  - [ ] Update AndroidManifest.xml and Info.plist with permission declarations
  - [ ] Test permission flows on both Android and iOS

- [ ] Task 6: Error Handling and User Feedback (AC: 5, 6)
  - [ ] Add error states to AppState for location issues
  - [ ] Implement user-friendly error messages for GPS disabled
  - [ ] Handle location service unavailable scenarios
  - [ ] Add retry mechanisms for transient location failures
  - [ ] Provide clear feedback during location acquisition
  - [ ] Test error scenarios and recovery mechanisms

## Dev Notes

### Data Model Requirements

[Source: architecture/data-models.md#userlocation]

- **UserLocation Class**: Required fields: latitude, longitude, timestamp; Optional: accuracy
- **Coordinate Validation**: Latitude (-90 to 90), Longitude (-180 to 180)
- **Helper Methods**: toLatLng() method for flutter_map LatLng conversion
- **Timestamp**: DateTime when position was captured for freshness tracking

### LocationService Architecture

[Source: architecture/components.md#locationservice]

- **Responsibility**: GPS position tracking, permission handling, location stream management
- **Key Interfaces**:
  - Stream<UserLocation> getLocationStream() for continuous updates
  - Future<UserLocation> getCurrentLocation() for one-time fetch
  - Future<bool> requestPermission() for permission handling
  - Future<bool> isLocationServiceEnabled() for GPS status check
- **Dependencies**: geolocator package, AppState integration
- **Technology**: Dart async/await and Streams, cross-platform GPS access

### State Management Integration

[Source: architecture/components.md#appstate]

- **AppState Structure**: ChangeNotifier with UserLocation? currentLocation field
- **Update Pattern**: LocationService → AppState.updateLocation() → notifyListeners()
- **Consumer Pattern**: MapScreen consumes AppState via Consumer<AppState>
- **Subscription Management**: Proper disposal of location streams in AppState

### Core Workflow Implementation

[Source: architecture/core-workflows.md#workflow-1]

- **App Launch Sequence**:
  1. LocationService.requestPermission() with user dialog
  2. User grants permission → LocationService.getLocationStream()
  3. GPS position → LocationService → AppState.updateLocation()
  4. AppState.notifyListeners() → MapScreen rebuilds with blue dot
- **Performance Target**: Location appears within 3 seconds of permission grant

### Platform Configuration Requirements

[Source: architecture/file-and-folder-structure.md]

- **Android Permissions**: ACCESS_FINE_LOCATION, ACCESS_COARSE_LOCATION in AndroidManifest.xml
- **iOS Permissions**: NSLocationWhenInUseUsageDescription in Info.plist
- **Permission Text**: "NaviMap needs your location to show routes from your current position"
- **Cross-Platform Support**: Must work on Android 7.0+ and iOS 12.0+ (NFR4)

### Geolocator Configuration

[Source: architecture/tech-stack.md]

- **Package Version**: geolocator 12.0.0 (cross-platform, robust permissions)
- **Location Settings**:
  - Accuracy: LocationAccuracy.high for navigation use
  - Distance Filter: 5 meters (reduce noise, preserve battery)
  - Update Interval: Based on movement for smooth tracking
- **Permission Handling**: Cross-platform permission request and status checking

### MapScreen Integration

[Source: architecture/components.md#mapscreen]

- **Marker Layer**: Add MarkerLayer to FlutterMap for location display
- **Blue Dot Marker**: Circular blue marker with semi-transparent accuracy ring
- **Auto-Centering**: Map centers on location when first detected (one-time)
- **Smooth Updates**: Location marker updates without jarring map movements
- **State Consumption**: Consumer<AppState> pattern for reactive location updates

### Error Handling Strategy

[Source: architecture/core-workflows.md]

- **Permission Denied**: Show settings redirect and graceful degradation
- **GPS Disabled**: Clear user message with instructions to enable location services
- **Network Issues**: Location works offline, no network dependency for GPS
- **Signal Loss**: Maintain last known location, show staleness indicator if needed
- **Service Unavailable**: Fallback to manual location entry (future enhancement)

## Testing

### Unit Testing Requirements

[Source: architecture/testing-strategy.md]

- **Model Tests**: test/models/user_location_test.dart for coordinate validation and helpers
- **Service Tests**: test/services/location_service_test.dart with mocked geolocator
- **State Tests**: test/state/app_state_test.dart for location update notifications
- **Mock Strategy**: Use mockito to mock geolocator package for consistent testing

### Widget Testing

[Source: architecture/testing-strategy.md]

- **MapScreen Tests**: Verify blue dot rendering with different AppState configurations
- **Permission Dialogs**: Test permission request UI and user flows
- **Error States**: Verify error message display for location failures
- **Consumer Testing**: Test MapScreen rebuilding when AppState location updates

### Integration Testing

- **Permission Flow**: Full permission request → grant → location display workflow
- **Location Updates**: Continuous location stream → AppState → MapScreen marker updates
- **Error Recovery**: GPS disabled → enabled → location restoration
- **Cross-Platform**: Test on both Android and iOS devices for platform-specific behavior

### Manual Testing Checklist

- [ ] Permission dialog appears on first launch with clear explanation
- [ ] Blue dot appears at current location after permission grant
- [ ] Map centers on user location when first detected
- [ ] Location marker updates smoothly when moving device
- [ ] Graceful handling when GPS is disabled (with clear message)
- [ ] Permission denied scenario handled with settings redirect option
- [ ] Works reliably on both Android 7.0+ and iOS 12.0+ devices
- [ ] Location accuracy is reasonable for navigation use

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-11-11 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated during implementation_

## QA Results

_This section will be populated during QA review_
