# Story 2.1: Destination Selection by Map Tap

## Status

Draft

## Story

**As a** user,
**I want** to set a destination by tapping anywhere on the map,
**so that** I can indicate where I want to navigate to.

## Acceptance Criteria

1. User can tap any point on map to set destination (FR3)
2. Red pin marker appears at tapped location (FR3)
3. Only one destination pin exists at a time (FR4)
4. New tap replaces existing destination pin (FR4)
5. Tap interaction responds within 100ms (NFR2)
6. Pin placement works across all zoom levels
7. Visual feedback confirms destination selection

## Tasks / Subtasks

- [ ] Task 1: Create Destination Data Model (AC: 1, 2)

  - [ ] Create lib/models/destination.dart with latitude/longitude fields
  - [ ] Add toLatLng() helper method for flutter_map integration
  - [ ] Include proper constructor with required parameters
  - [ ] Add coordinate validation for latitude/longitude ranges
  - [ ] Implement equality comparison for destination updates

- [ ] Task 2: Add Destination State to AppState (AC: 3, 4)

  - [ ] Add Destination? currentDestination field to AppState
  - [ ] Implement setDestination(Destination) method with notifyListeners()
  - [ ] Add clearDestination() method for removing current destination
  - [ ] Include destination-related loading and error states
  - [ ] Ensure single destination constraint (replace existing on new tap)

- [ ] Task 3: Implement Map Tap Gesture Handling (AC: 1, 5, 6)

  - [ ] Add GestureDetector to MapScreen for tap detection
  - [ ] Convert tap screen coordinates to map LatLng coordinates
  - [ ] Handle tap events across all zoom levels consistently
  - [ ] Ensure tap response meets 100ms performance requirement (NFR2)
  - [ ] Add tap gesture conflict resolution with map pan/zoom
  - [ ] Test tap accuracy at different zoom levels

- [ ] Task 4: Display Red Pin Marker for Destination (AC: 2, 3, 4, 7)

  - [ ] Add destination marker layer to FlutterMap using MarkerLayer
  - [ ] Create red pin marker widget for destination display
  - [ ] Position marker precisely at tapped coordinates
  - [ ] Handle marker visibility across zoom level changes
  - [ ] Replace existing pin when new destination is selected
  - [ ] Add visual feedback animation when pin is placed

- [ ] Task 5: Integrate Tap-to-Destination Workflow (AC: 1-7)

  - [ ] Wire GestureDetector tap event to AppState.setDestination()
  - [ ] Update MapScreen Consumer to rebuild when destination changes
  - [ ] Ensure smooth user experience: tap → pin placement → visual confirmation
  - [ ] Test complete workflow: tap → coordinate conversion → state update → marker display
  - [ ] Verify pin replacement works correctly for subsequent taps

- [ ] Task 6: Visual Feedback and User Experience (AC: 7)
  - [ ] Add subtle tap animation or visual confirmation
  - [ ] Ensure red pin marker is clearly visible and distinguishable
  - [ ] Test marker visibility against different map backgrounds
  - [ ] Add appropriate z-index layering (destination above location)
  - [ ] Implement smooth marker placement animation (optional enhancement)

## Dev Notes

### Destination Data Model

[Source: architecture/data-models.md#destination]

- **Destination Class**: Required fields: latitude, longitude (double precision)
- **Helper Methods**: toLatLng() method for flutter_map LatLng conversion
- **Coordinate Range**: Same validation as UserLocation (-90 to 90 lat, -180 to 180 lng)
- **Relationships**: Created by MapScreen tap gesture, consumed by RoutingService for future route calculation

### State Management Integration

[Source: architecture/components.md#appstate]

- **AppState Extension**: Add Destination? currentDestination field
- **State Methods**: setDestination(Destination) with notifyListeners() for reactive updates
- **Single Destination Constraint**: New destination replaces existing (no multiple pins)
- **Consumer Pattern**: MapScreen Consumer<AppState> rebuilds when destination changes

### Core Workflow Implementation

[Source: architecture/core-workflows.md#workflow-2]

- **Tap Sequence**: User taps map → MapScreen.onMapTap() → AppState.setDestination() → notifyListeners()
- **Visual Update**: AppState change → Consumer rebuilds → MarkerLayer displays red pin
- **Performance Target**: Tap response within 100ms (NFR2)
- **Coordinate Conversion**: Screen coordinates → map LatLng via flutter_map utilities

### MapScreen Integration

[Source: architecture/components.md#mapscreen]

- **GestureDetector Integration**: Wrap FlutterMap with GestureDetector for tap handling
- **Tap Handler**: onMapTap(LatLng coordinates) method to process destination selection
- **Marker Layers**: Add MarkerLayer for destination pin (separate from location layer)
- **Layer Ordering**: Location marker (blue dot) and destination marker (red pin) both visible

### Flutter Map Technical Details

[Source: architecture/tech-stack.md]

- **flutter_map Version**: 7.0.0 with tap gesture support
- **Coordinate System**: Uses LatLng from latlong2 package for coordinate representation
- **Marker Layer**: MarkerLayer widget for placing destination pin at precise coordinates
- **Gesture Handling**: Built-in tap detection with coordinate conversion utilities

### Visual Design Requirements

- **Red Pin Marker**: Clearly distinguishable red marker for destination
- **Visibility**: Pin must be visible across all zoom levels (appropriate sizing)
- **Z-Index**: Destination pin should appear above map tiles but allow location dot visibility
- **Animation**: Optional smooth placement animation for better user feedback
- **Conflict Resolution**: Pin placement shouldn't interfere with map pan/zoom gestures

### Performance Considerations

[Source: architecture/core-workflows.md]

- **Tap Response**: Must meet 100ms response time requirement (NFR2)
- **Coordinate Conversion**: Efficient screen-to-map coordinate transformation
- **State Updates**: Minimal AppState notifyListeners() calls to avoid unnecessary rebuilds
- **Marker Rendering**: Efficient marker layer updates without full map redraw

### Testing Strategy Integration

- **Unit Tests**: Destination model validation, coordinate conversion accuracy
- **Widget Tests**: Tap gesture detection, marker placement, Consumer rebuilding
- **Integration Tests**: Complete tap-to-pin workflow across different zoom levels
- **Performance Tests**: Tap response time measurement, gesture conflict resolution

## Testing

### Unit Testing Requirements

[Source: architecture/testing-strategy.md]

- **Model Tests**: test/models/destination_test.dart for coordinate validation and toLatLng()
- **State Tests**: test/state/app_state_test.dart for destination state management
- **Coordinate Tests**: Verify tap coordinate conversion accuracy at various zoom levels
- **Mock Testing**: Mock tap events and verify AppState updates correctly

### Widget Testing

[Source: architecture/testing-strategy.md]

- **MapScreen Tests**: Verify GestureDetector integration and tap handling
- **Marker Tests**: Test red pin marker rendering with different AppState configurations
- **Consumer Tests**: Verify MapScreen rebuilds when AppState destination changes
- **Gesture Tests**: Test tap gesture detection without interfering with pan/zoom

### Integration Testing

- **Tap Workflow**: Full tap → coordinate conversion → state update → marker display
- **Pin Replacement**: Verify new tap replaces existing destination pin correctly
- **Zoom Level Testing**: Test tap accuracy and pin visibility across zoom levels
- **Performance Testing**: Measure tap response time to meet 100ms requirement

### Manual Testing Checklist

- [ ] Tapping anywhere on map places red pin at exact tap location
- [ ] Only one red pin exists at a time (new tap replaces old pin)
- [ ] Tap response feels immediate (within 100ms)
- [ ] Pin placement works accurately at all zoom levels (5-18)
- [ ] Red pin is clearly visible against map background
- [ ] Tap gesture doesn't conflict with pan/zoom map interactions
- [ ] Pin remains visible and positioned correctly during map movements
- [ ] Visual feedback confirms successful destination selection

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-11-11 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated during implementation_

## QA Results

_This section will be populated during QA review_
